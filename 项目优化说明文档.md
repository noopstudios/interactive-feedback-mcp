模块化 Feedback UI 项目说明文档
1. 项目概述 (Project Overview)
本项目原为一个单一的 feedback_ui.py 文件，用于提供一个图形用户界面 (GUI) 以收集用户反馈，包括文本、预定义选项、图片和文件引用。为了提高代码的可读性、可维护性和可扩展性，我们将其进行了模块化拆分。

拆分后的项目将核心UI逻辑、自定义控件、对话框、以及辅助工具函数分别组织到不同的模块和包中。新的入口点是 main.py，而原有的 server.py（FastMCP工具）现在通过调用 main.py 来启动此UI。

2. 目录结构 (Directory Structure)
项目推荐的目录结构如下：

your_project_root/
├── feedback_ui/                 # UI主包 (Main UI Package)
│   ├── __init__.py              # 包初始化文件 (Package initializer)
│   ├── main_window.py           # FeedbackUI 主窗口类 (Main FeedbackUI window class)
│   ├── widgets/                 # 自定义UI控件 (Custom UI widgets)
│   │   ├── __init__.py
│   │   ├── clickable_label.py   # ClickableLabel, AtIconLabel 类
│   │   ├── feedback_text_edit.py # FeedbackTextEdit 类
│   │   └── image_preview.py     # ImagePreviewWidget 类
│   ├── dialogs/                 # 对话框类 (Dialog classes)
│   │   ├── __init__.py
│   │   ├── draggable_list_widget.py # DraggableListWidget 类
│   │   ├── manage_canned_responses_dialog.py # ManageCannedResponsesDialog 类
│   │   └── select_canned_response_dialog.py  # SelectCannedResponseDialog 类
│   └── utils/                   # 辅助工具和常量 (Utility modules and constants)
│       ├── __init__.py
│       ├── constants.py         # 应用常量和类型定义 (Application constants and type definitions)
│       ├── image_processor.py   # 图片处理函数 (Image processing functions)
│       ├── settings_manager.py  # QSettings 配置管理 (QSettings configuration management)
│       └── style_manager.py     # QSS样式和调色板管理 (QSS style and palette management)
├── main.py                      # UI应用程序的入口点 (Entry point for the UI application)
├── server.py                    # FastMCP 服务端脚本 (FastMCP server script)
└── images/                      # 存放图片资源 (Image resources)
    └── feedback.png             # 应用图标 (Application icon)

3. 模块详细说明 (Module Descriptions)
3.1. feedback_ui/ (主UI包)
__init__.py:

作用：将 feedback_ui 目录标记为一个Python包。

内容：可以包含包级别的初始化代码，例如定义 __version__。

main_window.py:

作用：包含应用程序的主窗口类 FeedbackUI。

核心类：

FeedbackUI(QMainWindow): 继承自 QMainWindow，构建和管理整个用户界面。它负责：

初始化窗口的基本属性（标题、图标、大小）。

从 SettingsManager 加载和保存窗口状态及用户偏好。

调用各个子模块（如 widgets 中的控件、dialogs 中的对话框）来构建UI布局。

处理顶层用户交互事件和信号（如按钮点击、窗口事件）。

协调图片处理、文本收集、文件引用管理等核心功能。

在关闭前准备并返回 FeedbackResult。

交互：与 utils 中的模块（如 SettingsManager, ImageProcessor）以及 widgets 和 dialogs 中的所有UI组件紧密协作。

3.2. feedback_ui/utils/ (辅助工具模块)
__init__.py: 使 utils 成为一个子包。

constants.py:

作用：定义项目中使用的所有全局常量和类型提示。

内容：

应用程序名称 (APP_NAME)。

QSettings 相关的键名（如 SETTINGS_KEY_GEOMETRY）。

图片处理限制（如 MAX_IMAGE_WIDTH）。

类型定义（ContentItem, FeedbackResult）。

优点：集中管理常量，便于修改和维护，避免魔法字符串。

style_manager.py:

作用：管理应用程序的视觉样式。

核心函数：

GLOBAL_QSS (str): 包含整个应用的全局Qt样式表 (QSS)。

get_dark_mode_palette() -> QPalette: 创建并返回一个暗色主题的 QPalette。

apply_global_style(app: QApplication): 将调色板和QSS应用到 QApplication 实例。

优点：分离样式代码，使主逻辑更清晰。

image_processor.py:

作用：封装所有与图像处理相关的逻辑。

核心函数：

process_single_image(pixmap: QPixmap) -> Optional[Dict[str, Any]]: 处理单个 QPixmap 对象，进行缩放、压缩（转为JPEG），并将其编码为Base64字符串。返回包含图像数据和元数据的字典。

get_image_items_from_widgets(image_widgets: Dict) -> List[ContentItem]: 从 ImagePreviewWidget 字典中收集所有图片并处理，返回 ContentItem 列表。

优点：图像处理逻辑集中，便于测试和修改。

settings_manager.py:

作用：封装与 QSettings 的所有交互，用于持久化存储用户偏好和窗口状态。

核心类：

SettingsManager(QObject): 提供方法来获取和设置各种配置项，如：

主窗口的几何形状和状态。

窗口是否置顶。

常用语列表。

快捷图标的显示偏好。

优点：配置存储逻辑与UI代码分离，更易管理。

3.3. feedback_ui/widgets/ (自定义UI控件)
__init__.py: 使 widgets 成为一个子包。

clickable_label.py:

作用：提供可点击的标签控件。

核心类：

ClickableLabel(QLabel): 一个可以发出 clicked 信号的 QLabel。

AtIconLabel(QLabel): 一个特殊的可点击标签，显示 "@" 符号，用于触发特定操作（如显示常用语数字快捷键）。

feedback_text_edit.py:

作用：提供一个功能增强的文本编辑框。

核心类：

FeedbackTextEdit(QTextEdit): 处理纯文本输入，支持：

图片拖放和粘贴。

文件拖放，并在文本中插入特殊格式的引用标记 (@filename)。

管理和删除这些文件引用标记。

在底部显示已添加图片的预览容器 (images_container)。

Enter键提交，Shift+Enter换行。

交互：与 FeedbackUI (其父窗口) 紧密交互以处理图片添加和文件引用。

image_preview.py:

作用：显示单个图片的缩略图预览。

核心类：

ImagePreviewWidget(QWidget):

显示一个小尺寸的图片缩略图。

鼠标悬停时，在光标附近弹出一个更大的图片预览窗口。

点击时，发出 image_deleted (int) 信号，通知父窗口删除对应的图片。

3.4. feedback_ui/dialogs/ (对话框)
__init__.py: 使 dialogs 成为一个子包。

draggable_list_widget.py:

作用：提供一个支持项目拖拽排序的列表控件。

核心类：

DraggableListWidget(QListWidget): 允许用户通过拖放来重新排列列表中的项目。发出 drag_completed 和 item_double_clicked 信号。

manage_canned_responses_dialog.py:

作用：提供一个管理（增删改查）常用语的对话框。

核心类：

ManageCannedResponsesDialog(QDialog): 允许用户查看、添加、编辑、删除和清空常用语列表。更改会通过 SettingsManager 保存。

select_canned_response_dialog.py:

作用：提供一个选择和管理常用语的对话框，通常由此对话框插入常用语到主文本框。

核心类：

SelectCannedResponseDialog(QDialog):

使用 DraggableListWidget 显示常用语。

允许用户添加新的常用语、删除现有常用语、以及拖拽排序。

双击列表中的常用语会将其插入到 FeedbackUI 的 FeedbackTextEdit 中，并关闭对话框。

管理“显示快捷图标”的复选框状态。

3.5. main.py (应用程序入口点)
作用：作为独立的GUI应用程序的启动脚本。

职责：

解析命令行参数 (--prompt, --predefined-options, --output-file 等)。

创建 QApplication 实例。

调用 feedback_ui.utils.style_manager.apply_global_style() 应用全局样式和调色板。

实例化 feedback_ui.main_window.FeedbackUI。

调用 FeedbackUI 实例的 run_ui_and_get_result() 方法来显示UI并获取结果。

如果指定了 --output-file，则将结果保存到JSON文件；否则，可以将结果打印到标准输出。

启动并管理 QApplication 的事件循环。

3.6. server.py (FastMCP 服务端)
作用：原有的 FastMCP 工具脚本。

修改：

launch_feedback_ui 函数现在通过 subprocess.run() 调用 python main.py （而不是 python feedback_ui.py），并传递必要的命令行参数。

它仍然负责从 main.py 执行后生成的临时JSON文件中读取反馈结果。

3.7. images/ (图片资源目录)
feedback.png: 应用程序的图标文件。

4. 关键类及其角色
FeedbackUI (main_window.py): 应用程序的“大脑”和主框架，负责组织所有UI元素和协调它们之间的交互。

FeedbackTextEdit (widgets/feedback_text_edit.py): 核心输入控件，处理复杂的文本、图片和文件引用混合输入。

SettingsManager (utils/settings_manager.py): 集中管理所有持久化设置的读写，与UI逻辑分离。

ImageProcessor (utils/image_processor.py): 负责所有图片相关的转换和压缩逻辑。

对话框类 (dialogs/): 提供独立的、模态的交互窗口，用于特定任务（如管理常用语）。

5. 执行流程 (Execution Flow)
由 server.py 启动时:

server.py 中的 interactive_feedback MCP工具被调用。

launch_feedback_ui 函数执行 python main.py --prompt "..." --output-file "temp.json" ...。

main.py 启动，解析参数，创建 QApplication 和 FeedbackUI。

用户与 FeedbackUI 交互并提交反馈。

FeedbackUI 将结果写入 output_file (临时JSON文件)。

main.py 退出。

server.py 读取临时JSON文件，获取结果，并继续其 FastMCP 流程。

直接运行 main.py 时 (用于UI测试和独立查看):

执行 python main.py [参数...]。

main.py 解析参数，创建 QApplication 和 FeedbackUI。

UI显示，用户交互。

如果提供了 --output-file，结果保存到文件；否则，结果可能打印到控制台（取决于 main.py 的实现）。

关闭UI窗口后，main.py 退出。

6. 主要依赖 (Key Dependencies)
PySide6: Qt for Python 库，用于构建整个GUI。

(可选) pyperclip: 如果剪贴板操作需要更底层的支持（尽管 QApplication.clipboard() 通常足够）。

7. 如何运行 (How to Run)
独立运行UI:
在项目根目录下执行: python main.py [可选参数]
例如: python main.py --prompt "请提供您的宝贵意见：" --full-ui

通过 server.py 运行 (作为MCP工具):
在项目根目录下执行: python server.py
然后通过FastMCP的机制调用 interactive_feedback 工具。

这份文档概述了模块化后的项目结构和各个组件的功能。这种结构使得代码更易于理解、修改和扩展。