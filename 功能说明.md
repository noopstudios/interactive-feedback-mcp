# interactive-feedback-mcp 功能说明

本文档详细介绍 `interactive-feedback-mcp` 服务的各项功能，旨在帮助用户全面了解其用途、交互方式以及与 AI 助手的协作流程。

## 快速开始

### 安装方式

**推荐方式（uvx）：**
```bash
uvx interactive-feedback@latest
```

**或使用pip：**
```bash
pip install interactive-feedback
```

**PyPI项目页面：** https://pypi.org/project/interactive-feedback/

### MCP配置示例
```json
{
  "mcpServers": {
    "interactive-feedback": {
      "command": "uvx",
      "args": ["interactive-feedback@latest"],
      "timeout": 600,
      "autoApprove": ["interactive_feedback"]
    }
  }
}
```

详细安装和配置说明请参阅 [安装与配置指南.md](./安装与配置指南.md)。

## 1. 项目简介

`interactive-feedback-mcp` 是一个模型上下文协议 (MCP) 服务，它通过在 AI 助手（如 Cursor）需要用户输入、澄清或确认时，弹出一个功能丰富的图形用户界面 (GUI) 反馈窗口。此服务旨在提升人与 AI 之间协作的效率、准确性和灵活性，支持文本、图片以及文件引用等多种反馈形式。

## 2. 核心功能

### 2.1. 交互式反馈窗口

*   **触发方式**：
    *   AI 助手通过调用本 MCP 服务提供的 `interactive_feedback` 工具时，会自动弹出反馈窗口。
    *   用户也可以主动告知 AI 助手："请用 `interactive_feedback mcp` 工具与我对话"来手动触发。
*   **文本输入**：用户可以在主输入框中输入纯文本反馈。支持通过按 `Enter`键发送反馈，按 `Shift+Enter` 组合键进行换行。
*   **预定义选项**：如果 AI 助手在调用时提供了 `predefined_options` 参数，这些选项会以带文本描述的复选框形式显示。用户可以直接勾选一个或多个选项，选中的选项文本会自动整合到最终发送的反馈内容中。

### 2.2. 图片处理与反馈

*   **图片粘贴**：用户可以直接在反馈输入框中使用 `Ctrl+V` (或 macOS 上的 `Cmd+V`) 粘贴剪贴板中的单张或多张图片。
*   **图片拖拽**：支持从本地文件系统直接拖拽图片文件到文本输入框中进行添加。
*   **图片预览与管理**：
    *   添加的图片会在文本输入框下方以缩略图形式显示。
    *   鼠标悬停在缩略图上会显示更大尺寸的图片预览及图片尺寸信息。
    *   点击缩略图可以直接删除该图片。
*   **图片处理机制**：为了优化传输和 AI 处理，图片在发送前会进行处理：
    *   尺寸调整：较大的图片会被缩放到预设的最大宽度和高度（例如 512x512 像素），同时保持宽高比。
    *   格式与压缩：图片统一转换为 JPEG 格式，并可能根据需要调整压缩质量以满足大小限制（例如 1MB）。
*   **发送方式**：图片数据会经过 Base64 编码后，与文本内容一起作为结构化数据返回给 AI 助手。

### 2.3. 文件引用拖拽 ✨ 最新优化

*   **文件拖拽**：用户可以将本地文件系统中的文件拖拽到文本输入框中。
*   **引用生成**：拖拽文件后，会在文本框的光标位置插入一个特殊格式的引用文本，如 `@{文件名}`。此引用文本以**蓝色加粗**样式显示，与普通文本明确区分。
*   **智能光标定位**：拖拽文件后，光标自动定位到文件引用末尾，用户可以立即继续输入文本，避免光标错误出现在文件名中间。
*   **智能重复检测**：支持拖拽多个文件。只有当输入框中真正存在同名文件时，才会自动添加序号（如 `@{文件名}(1)`）以区分。删除文件后再次拖拽不会错误添加序号。
*   **引用删除**：用户可以通过标准的文本编辑操作（如退格键、删除键）删除这些文件引用文本。整个引用（例如 `@{文件名}`）会被视为一个单元进行删除，系统会自动清理相关引用数据。
*   **数据传递**：文件引用的显示名及其对应的本地文件路径会作为结构化数据的一部分返回给 AI 助手。

### 2.4. 常用语管理 ✨ 最新优化

*   **快速插入**：用户可以预设和管理常用的反馈短语。
*   **hover预览功能**：鼠标悬停在"常用语"按钮上时，会自动显示常用语预览窗口，支持滚动查看所有常用语（无数量限制）。
*   **流畅交互**：鼠标可以从按钮流畅移动到预览窗口，点击预览中的常用语可直接插入到输入框，无需打开管理对话框。
*   **主题适配**：预览窗口支持深色/浅色主题动态切换，与整体UI风格保持一致。
*   **管理界面**：通过反馈窗口界面上的"常用语"按钮点击，可以打开常用语管理对话框。
*   **优化布局**：管理对话框采用更清晰的布局结构，输入区域独立成行，底部左侧保存按钮，右侧关闭按钮。
*   **功能**：在管理界面中，用户可以添加新的常用语、编辑或删除已有的常用语，并支持拖拽排序。
*   **使用**：在常用语选择对话框中，双击某个常用语即可将其内容插入到主反馈输入框的当前光标位置。

### 2.5. 文件选择功能 ✨ 新增功能

*   **选择文件按钮**：界面提供专门的"选择文件"按钮，位于常用语按钮和终端按钮之间。
*   **文件选择对话框**：点击按钮后打开系统标准的文件选择对话框，支持多文件选择。
*   **智能文件处理**：
    *   **图片文件**：自动识别常见图片格式（jpg、png、gif、bmp等），作为图片预览添加到界面。
    *   **普通文件**：生成蓝色加粗的文件引用（如 `@文件名.txt`），插入到文本输入框的光标位置。
*   **统一体验**：通过按钮选择的文件与拖拽文件享有相同的处理逻辑、显示效果和交互体验。
*   **多语言支持**：按钮文本和提示信息支持中英文切换。

### 2.6. 原生终端窗口功能 ✨ 重大升级

*   **多终端支持**：支持三种常用终端类型：
    *   **PowerShell** (🔷)：Windows PowerShell，功能强大的命令行工具
    *   **Git Bash** (🔶)：Git for Windows提供的Bash环境，支持完整的ANSI颜色
    *   **Command Prompt** (⬛)：传统的Windows命令提示符
*   **hover预览功能**：鼠标悬停在"终端"按钮上时，自动显示终端类型选择预览窗口。
*   **真正的原生终端体验** 🎯：
    *   **直接输入模式**：可以直接在终端输出区域内输入命令，完全模拟真实终端体验
    *   **智能光标激活**：终端启动后光标自动定位到提示符后并开始闪动，用户可立即输入
    *   **完整键盘支持**：支持上下箭头浏览命令历史、Home/End键导航、退格删除等
    *   **智能输入限制**：自动限制编辑区域在当前命令行，防止误编辑历史输出
*   **完整的ANSI支持**：
    *   **彩色输出**：完美支持终端的彩色文本显示（如Git Bash的蓝色目录、绿色文件等）
    *   **转义序列解析**：智能解析ANSI转义序列，正确显示颜色、粗体、下划线等格式
    *   **编码兼容**：支持UTF-8编码，正确显示中文文件名和路径
*   **智能提示符识别**：
    *   **多格式支持**：自动识别PowerShell (`PS>`), Git Bash (`$`), CMD (`>`) 等不同提示符
    *   **Windows路径支持**：智能识别Windows路径提示符（如 `C:\Users\Name>`）
    *   **自动模式切换**：根据输出内容自动在显示模式和输入模式间切换
*   **原生终端外观**：
    *   **统一深色背景**：整个终端窗口采用统一的深色背景（#1e1e1e），完全模拟原生终端
    *   **无边框设计**：终端区域无边框，提供无缝的原生体验
    *   **原生工具栏**：深色工具栏配合悬停效果，完全融入终端环境
*   **高级功能**：
    *   **命令历史**：支持上下箭头浏览和重用之前执行的命令
    *   **空回车处理**：正确处理空回车操作，保持终端状态一致
    *   **多终端兼容**：在PowerShell、Git Bash、CMD下都能正常工作
*   **窗口管理**：终端窗口支持独立的大小调整、位置记忆、置顶显示等功能。

### 2.7. 界面布局选择 ✨ 新增功能

*   **双布局模式**：
    *   **垂直布局**：传统的上下分布模式，提示文字在上方，选项和输入区域在下方。
    *   **水平布局**：左右分布模式，提示文字在左侧占据全高度，选项和输入区域在右侧。
*   **实时切换**：在设置页面可以通过单选按钮实时切换布局模式，无需重启应用。
*   **可拖拽分割器**：
    *   两种布局模式都支持拖拽分割器手动调整各区域大小。
    *   **垂直布局**：拖拽水平分割器调整上下区域高度比例。
    *   **水平布局**：拖拽垂直分割器调整左右区域宽度比例。
*   **双击重置**：双击分割器手柄可快速重置为默认比例。
*   **状态保存**：分割器位置、布局选择会自动保存到设置文件，下次启动时自动恢复。
*   **最小尺寸限制**：各区域都有最小尺寸限制，确保界面元素始终可用。

### 2.8. 优化和增强功能 ✨ 全新功能

*   **文本优化功能**：
    *   **一键优化**：将用户的口语化、可能存在歧义的输入转换为结构化、逻辑清晰的指令
    *   **自定义增强**：支持用户自定义增强指令，按照特定要求处理文本内容
    *   **智能处理**：自动识别文本特点，提供最适合的优化建议
*   **多AI提供商支持**：
    *   **OpenAI**：支持GPT-4o-mini等模型，提供高质量的文本优化
    *   **Google Gemini**：支持Gemini-2.0-flash等模型，快速响应
    *   **DeepSeek**：支持DeepSeek-chat等模型，成本效益优化
    *   **火山引擎**：支持DeepSeek-v3等模型，国内访问优化
*   **API密钥管理**：
    *   **UI配置**：通过设置页面统一管理所有提供商的API密钥
    *   **安全存储**：API密钥安全存储在本地配置文件中
    *   **实时验证**：输入API密钥时进行格式验证和可用性检查
*   **优化体验**：
    *   **加载动画**：优化处理时显示加载动画，提供清晰的视觉反馈
    *   **撤销功能**：支持Ctrl+Z撤销优化结果，恢复原始文本
    *   **自动光标定位**：优化完成后自动激活输入框光标，便于继续编辑
    *   **错误处理**：完善的错误提示和重试机制，确保稳定使用

### 2.9. 音频提示功能 ✨ 新增功能

*   **智能提示音**：
    *   **自动播放**：窗口弹出时自动播放提示音，提醒用户注意
    *   **默认音频**：项目内置默认提示音文件（wx.wav），确保开箱即用
    *   **自定义音频**：支持用户自定义提示音文件，个性化体验
*   **音频管理**：
    *   **音量控制**：支持音量调节，适应不同使用环境
    *   **播放状态监控**：实时监控音频播放状态，提供播放完成回调
    *   **错误处理**：音频播放失败时提供错误信息和降级处理
*   **跨平台兼容**：
    *   **Qt多媒体框架**：基于PySide6的多媒体模块，确保跨平台兼容性
    *   **格式支持**：支持常见音频格式（WAV、MP3等）
    *   **系统集成**：与系统音频设置无缝集成

### 2.10. 窗口截图功能 ✨ 新增功能

*   **矩形选择截图**：
    *   **全屏覆盖**：截图时创建全屏覆盖窗口，提供完整的截图体验
    *   **矩形选择**：支持鼠标拖拽选择任意矩形区域进行截图
    *   **实时预览**：选择过程中提供实时的选择区域预览效果
*   **智能窗口管理**：
    *   **自动最小化**：截图开始时自动最小化UI窗口，避免干扰
    *   **状态保存**：保存窗口状态（位置、大小、固定状态等）
    *   **自动恢复**：截图完成或取消后自动恢复窗口到原始状态
*   **图片集成**：
    *   **无缝添加**：截图完成后自动添加到输入内容中
    *   **格式统一**：与其他图片功能使用相同的处理和显示逻辑
    *   **预览支持**：截图图片支持缩略图预览和管理功能
*   **用户体验**：
    *   **快捷操作**：一键启动截图，简化操作流程
    *   **取消支持**：支持ESC键或右键取消截图操作
    *   **最小尺寸限制**：确保截图区域有效，避免无意义的小区域截图

### 2.11. 显示模式配置 ✨ 新增功能

*   **双显示模式**：
    *   **简单模式**：显示AI处理后的简洁问题或提示，适合快速交互
    *   **完整模式**：显示AI的原始完整回复内容，适合详细查看和分析
*   **智能内容适配**：
    *   **自动选择**：根据用户配置的显示模式自动选择合适的显示内容
    *   **参数支持**：AI可以同时传递简单和完整两种内容，由系统自动选择
    *   **降级处理**：当某种模式的内容不可用时，自动使用可用的内容
*   **配置管理**：
    *   **实时切换**：可在设置页面实时切换显示模式，立即生效
    *   **持久化保存**：显示模式选择会自动保存，下次启动时恢复
    *   **用户友好**：通过单选按钮形式提供直观的模式选择界面

### 2.12. 窗口行为与控制 ✨ 最新改进

*   **窗口固定**：提供"固定窗口"按钮，点击后窗口将保持在最前端显示，即使失去焦点也不会自动最小化。再次点击可取消固定。修复了取消固定时关闭按钮失效的问题。
*   **自动最小化**：默认情况下，当反馈窗口失去焦点时会自动最小化（除非窗口被固定）。
*   **UI持久化**：窗口的大小、位置、布局模式、分割器状态以及固定状态会被保存，并在下次启动时恢复。

## 3. 提供的 MCP 工具

本服务通过 MCP 向 AI 助手公开以下核心工具：

### `interactive_feedback`

*   **功能**：向用户发起交互式会话，显示提示信息，提供可选选项，并收集用户的文本、图片和文件引用反馈。
*   **参数**：
    *   `message` (str, 可选): 简单模式下显示的简洁问题或提示
    *   `full_response` (str, 可选): 完整模式下显示的AI原始完整回复内容
    *   `predefined_options` (List[str], 可选): 一个字符串列表，每个字符串代表一个用户可以选择的预定义选项。如果提供，这些选项会显示为复选框。
*   **显示模式说明**：
    *   **简单模式**：使用 `message` 参数内容，显示简洁的问题或提示
    *   **完整模式**：使用 `full_response` 参数内容，显示完整的AI回复
    *   **智能降级**：如果当前模式对应的参数为空，自动使用可用的参数内容
*   **返回给AI助手的数据格式**：
    该工具会返回一个包含结构化反馈内容的元组 (Tuple)。元组中的每个元素可以是字符串 (文本反馈或文件引用信息) 或 `fastmcp.Image` 对象 (图片反馈)。
    具体来说，从UI收集到的数据会转换成以下 `content` 项列表，并由 `server.py` 进一步处理成 FastMCP兼容的元组：
    ```json
    // UI返回给server.py的原始JSON结构示例
    {
      "content": [
        {"type": "text", "text": "用户的文本反馈..."},
        {"type": "image", "data": "base64_encoded_image_data", "mimeType": "image/jpeg"},
        {"type": "file_reference", "display_name": "@example.txt", "path": "/path/to/local/example.txt"}
        // ... 可能有更多项
      ]
    }
    ```
    *   **文本内容** (`type: "text"`)：包含用户输入的文本和/或选中的预定义选项组合文本。
    *   **图片内容** (`type: "image"`)：包含 Base64 编码后的图片数据和图片的 MIME 类型 (如 `image/jpeg`)。这些在 `server.py` 中会被转换为 `fastmcp.Image` 对象。
    *   **文件引用** (`type: "file_reference"`)：包含用户拖拽的文件的显示名 (如 `@filename.txt`) 和其在用户本地的完整路径。这些信息通常会作为文本字符串传递给AI助手。

    **注意**：即使没有任何用户输入（例如用户直接关闭反馈窗口），工具也会返回一个表示"无反馈"的特定消息，如 `("[User provided no feedback]",)`。

### `optimize_user_input`

*   **功能**：使用配置的LLM API来优化或增强用户输入的文本，将口语化、可能存在歧义的输入转化为更结构化、更清晰、更便于AI模型理解的文本。
*   **参数**：
    *   `original_text` (str): **必须参数**。用户的原始输入文本
    *   `mode` (str): **必须参数**。优化模式：
        *   `'optimize'`: 一键优化，使用预设的通用优化指令
        *   `'reinforce'`: 提示词强化，使用用户自定义的强化指令
    *   `reinforcement_prompt` (str, 可选): 在 'reinforce' 模式下用户的自定义指令
*   **支持的AI提供商**：
    *   **OpenAI**: GPT-4o-mini 等模型，提供高质量的文本优化
    *   **Google Gemini**: Gemini-2.0-flash 等模型，快速响应和处理
    *   **DeepSeek**: DeepSeek-chat 等模型，成本效益优化
    *   **火山引擎**: DeepSeek-v3 等模型，国内访问优化
*   **配置要求**：
    *   需要在UI设置页面配置相应提供商的API密钥
    *   支持自定义优化和增强提示词
    *   提供完善的错误处理和重试机制
*   **返回**：优化后的文本内容或详细的错误信息

## 4. 界面与体验增强 ✨ 最新改进

*   **深色模式 UI**：界面采用深色主题，提供舒适的视觉体验。
*   **快捷键支持**：
    *   `Enter`：提交反馈。
    *   `Shift+Enter`：在文本输入框中换行。
    *   `Ctrl+V` (或 `Cmd+V`)：粘贴内容（包括图片和文本）。
*   **文本编辑器优化**：
    *   针对长按退格键的优化、光标可见性处理、文本格式化等，提供更流畅的输入体验。
    *   智能提示文字：输入框获得焦点时自动隐藏提示文字，失去焦点且无内容时恢复显示。
    *   增强提示内容：包含拖拽文件和图片提示，以及快捷键说明。
*   **设置页面优化**：
    *   **统一UI风格**：所有设置项（外观主题、界面布局、展示语言、字体大小）都使用单选按钮形式，保持界面一致性。
    *   **逻辑排序**：设置项按外观主题、界面布局、展示语言、字体大小的逻辑顺序排列，符合用户使用习惯。
    *   **实时预览**：布局和主题设置支持实时预览效果，无需重启应用。
*   **hover交互增强**：
    *   **常用语预览**：鼠标悬停在常用语按钮上时显示预览窗口，支持无限滚动。
    *   **终端预览**：鼠标悬停在终端按钮上时显示终端类型选择窗口。
    *   **流畅交互**：鼠标可以从按钮流畅移动到预览窗口，提供延迟隐藏机制。
*   **可点击的提示标签**：窗口顶部的提示信息标签允许用户选择和复制文本内容。
*   **富文本支持**：文本编辑器现在支持富文本格式，用于显示带颜色的文件引用。
*   **响应式布局**：界面支持不同布局模式，并能根据窗口大小自动调整元素排列。
*   **优化体验增强**：
    *   **加载动画**：文本优化处理时在UI窗口中心显示加载动画，提供清晰的视觉反馈。
    *   **撤销功能**：优化完成后支持Ctrl+Z撤销操作，恢复到原始文本状态。
    *   **自动光标激活**：优化完成后自动激活输入框光标，便于用户继续编辑。
*   **音频提示**：窗口弹出时播放提示音，提醒用户注意交互界面的出现。
*   **截图集成**：窗口截图功能与现有图片处理流程无缝集成，提供一致的用户体验。

## 5. 技术架构与代码优化 ✨ 最新优化

*   **代码架构优化**：
    *   **统一终端管理**：使用`TerminalManager`统一管理所有终端类型的检测、配置和启动
    *   **样式系统重构**：创建`terminal_styles.py`工具模块，统一管理终端组件的字体和样式
    *   **组件简化**：移除传统模式组件，专注于原生终端体验
    *   **代码清理**：移除重复的检测逻辑、未使用的参数和导入，减少28%的代码量
*   **性能优化**：
    *   **智能ANSI解析**：优化的ANSI转义序列解析器，支持完整的颜色和格式
    *   **编码兼容性**：智能编码检测，支持UTF-8、GBK等多种编码格式
    *   **内存管理**：优化图片处理和文件引用管理，减少内存占用
*   **用户体验提升**：
    *   **即时响应**：光标自动激活、智能聚焦、流畅的键盘交互
    *   **视觉一致性**：统一的深色主题、原生终端外观、无边框设计
    *   **交互优化**：悬停预览、拖拽支持、快捷键操作