# 布局优化与左右布局实现方案

## 项目概述

本文档详细描述了Interactive Feedback MCP项目的两个重要优化任务：
1. **底部区域空间优化** - 减少空间浪费，提升界面紧凑性
2. **左右布局功能实现** - 新增混合布局选项，提供更灵活的界面布局

## 任务1：底部区域空间优化

### 🎯 目标
优化当前底部区域的空间利用，减少不必要的空白，为后续混合布局实现提供更多可用空间。

### 📊 当前问题分析
- GitHub链接文字过长：`"Project GitHub"` 占用过多空间
- 各区域边距设置过大：GitHub区域上边距10px，底部按钮区域边距5px
- 提交按钮高度偏大：当前50px最小高度
- 整体垂直空间利用率不高

### 🔧 具体优化措施

#### 1.1 GitHub链接优化
**文件**: `src/feedback_ui/main_window.py`
**方法**: `_create_github_link_area()`
**修改内容**:
```python
# 修改前
github_label = QLabel(
    "<a href='https://github.com/lucas-710/interactive-feedback-mcp'>Project GitHub</a>"
)

# 修改后
github_label = QLabel(
    "<a href='https://github.com/lucas-710/interactive-feedback-mcp'>GitHub</a>"
)
# 添加小字体样式
github_label.setStyleSheet("font-size: 10pt; color: #888888;")
```

#### 1.2 边距优化
**GitHub区域边距优化**:
```python
# 修改前
github_layout.setContentsMargins(0, 10, 0, 0)

# 修改后
github_layout.setContentsMargins(0, 5, 0, 0)
```

**底部按钮区域边距优化**:
```python
# 修改前
bottom_layout.setContentsMargins(0, 5, 0, 5)

# 修改后
bottom_layout.setContentsMargins(0, 3, 0, 3)
```

#### 1.3 提交按钮高度优化
**文件**: `src/feedback_ui/main_window.py`
**方法**: `_create_ui_layout()`
**修改内容**:
```python
# 修改前
self.submit_button.setMinimumHeight(50)

# 修改后
self.submit_button.setMinimumHeight(42)
```

### 📈 预期效果
- 节省垂直空间：约15-20px
- 保持界面美观和可读性
- 为混合布局实现提供更多可用空间

## 任务2：左右布局功能实现

### 🎯 目标
实现混合布局功能，支持用户在设置中切换上下布局和左右布局，提供更灵活的界面使用体验。

### 🎨 最终布局设计

#### 2.1 上下布局（当前）
```
┌─────────────────────────────────────────┐
│            提示文字区域                  │
├─────────────────────────────────────────┤ ← 水平分割线
│            选项区域                      │
│            输入框区域                    │
├─────────────────────────────────────────┤
│            按钮区域                      │
└─────────────────────────────────────────┘
```

#### 2.2 左右布局（新增）- 混合布局
```
┌─────────────────┬─────────────────────────┐
│                 │  ┌─────────────────────┐ │
│                 │  │    选项区域         │ │
│   提示文字区域   │  │  (如果有选项)       │ │ ← 上部分割区域
│                 │  └─────────────────────┘ │
│                 │  ┌─────────────────────┐ │
│                 │  │    输入框区域       │ │
│                 │  └─────────────────────┘ │
├─────────────────┴─────────────────────────┤
│              按钮区域（横跨全宽）            │ ← 底部独立区域
└─────────────────────────────────────────────┘
```

### 🔧 技术实现方案

#### 2.1 常量定义扩展
**文件**: `src/feedback_ui/utils/constants.py`
**新增内容**:
```python
# 布局方向常量
LAYOUT_VERTICAL = "vertical"      # 上下布局
LAYOUT_HORIZONTAL = "horizontal"  # 左右布局
DEFAULT_LAYOUT_DIRECTION = LAYOUT_VERTICAL

# 设置键
SETTINGS_KEY_LAYOUT_DIRECTION = "ui/layout_direction"
SETTINGS_KEY_HORIZONTAL_SPLITTER_SIZES = "ui/horizontal_splitter_sizes"
SETTINGS_KEY_HORIZONTAL_SPLITTER_STATE = "ui/horizontal_splitter_state"

# 默认分割比例
DEFAULT_HORIZONTAL_SPLITTER_RATIO = [400, 600]  # 左右比例 4:6
MIN_LEFT_AREA_WIDTH = 300
MIN_RIGHT_AREA_WIDTH = 400
```

#### 2.2 设置管理器扩展
**文件**: `src/feedback_ui/utils/settings_manager.py`
**新增方法**:
```python
def get_layout_direction(self) -> str:
    """获取布局方向设置"""
    return self.settings.value(SETTINGS_KEY_LAYOUT_DIRECTION, DEFAULT_LAYOUT_DIRECTION)

def set_layout_direction(self, direction: str):
    """设置布局方向"""
    self.settings.setValue(SETTINGS_KEY_LAYOUT_DIRECTION, direction)
    self.settings.sync()

def get_horizontal_splitter_sizes(self) -> list:
    """获取水平分割器尺寸"""
    try:
        sizes = self.settings.value(SETTINGS_KEY_HORIZONTAL_SPLITTER_SIZES, DEFAULT_HORIZONTAL_SPLITTER_RATIO)
        if isinstance(sizes, list) and len(sizes) == 2:
            return [int(size) for size in sizes]
    except (ValueError, TypeError):
        pass
    return DEFAULT_HORIZONTAL_SPLITTER_RATIO

def set_horizontal_splitter_sizes(self, sizes: list):
    """设置水平分割器尺寸"""
    if isinstance(sizes, list) and len(sizes) == 2:
        self.settings.beginGroup(SETTINGS_GROUP_MAIN)
        self.settings.setValue(SETTINGS_KEY_HORIZONTAL_SPLITTER_SIZES, sizes)
        self.settings.endGroup()
        self.settings.sync()

def get_horizontal_splitter_state(self) -> bytes:
    """获取水平分割器状态"""
    self.settings.beginGroup(SETTINGS_GROUP_MAIN)
    state = self.settings.value(SETTINGS_KEY_HORIZONTAL_SPLITTER_STATE, b"")
    self.settings.endGroup()
    return state if isinstance(state, bytes) else b""

def set_horizontal_splitter_state(self, state: bytes):
    """设置水平分割器状态"""
    if isinstance(state, bytes):
        self.settings.beginGroup(SETTINGS_GROUP_MAIN)
        self.settings.setValue(SETTINGS_KEY_HORIZONTAL_SPLITTER_STATE, state)
        self.settings.endGroup()
        self.settings.sync()
```

#### 2.3 主窗口架构重构
**文件**: `src/feedback_ui/main_window.py`

##### 2.3.1 布局创建方法重构
```python
def _create_ui_layout(self):
    """根据设置创建对应的UI布局"""
    central_widget = QWidget()
    self.setCentralWidget(central_widget)
    
    # 获取布局方向设置
    layout_direction = self.settings_manager.get_layout_direction()
    
    if layout_direction == LAYOUT_HORIZONTAL:
        self._create_horizontal_layout(central_widget)
    else:
        self._create_vertical_layout(central_widget)

def _create_vertical_layout(self, central_widget: QWidget):
    """创建上下布局（当前布局）"""
    # 当前的实现逻辑
    main_layout = QVBoxLayout(central_widget)
    main_layout.setContentsMargins(20, 5, 20, 10)
    main_layout.setSpacing(15)
    
    # 创建垂直分割器
    self.main_splitter = QSplitter(Qt.Orientation.Vertical)
    self.main_splitter.setObjectName("mainSplitter")
    self.main_splitter.setChildrenCollapsible(False)
    
    # 上部区域和下部区域
    self.upper_area = self._create_upper_area()
    self.lower_area = self._create_lower_area()
    
    self.main_splitter.addWidget(self.upper_area)
    self.main_splitter.addWidget(self.lower_area)
    
    self._setup_vertical_splitter_properties()
    main_layout.addWidget(self.main_splitter)
    
    # 底部按钮和GitHub链接
    self._setup_bottom_bar(main_layout)
    self._create_submit_button(main_layout)
    self._create_github_link_area(main_layout)

def _create_horizontal_layout(self, central_widget: QWidget):
    """创建左右布局（混合布局）"""
    main_layout = QVBoxLayout(central_widget)
    main_layout.setContentsMargins(20, 5, 20, 10)
    main_layout.setSpacing(15)
    
    # 创建上部分割区域
    upper_splitter_area = self._create_upper_splitter_area()
    main_layout.addWidget(upper_splitter_area, 1)  # 占据主要空间
    
    # 创建底部按钮区域（横跨全宽）
    self._setup_bottom_bar(main_layout)
    self._create_submit_button(main_layout)
    self._create_github_link_area(main_layout)

def _create_upper_splitter_area(self) -> QWidget:
    """创建上部分割区域（左右布局专用）"""
    splitter_container = QWidget()
    splitter_layout = QVBoxLayout(splitter_container)
    splitter_layout.setContentsMargins(0, 0, 0, 0)
    
    # 创建水平分割器
    self.main_splitter = QSplitter(Qt.Orientation.Horizontal)
    self.main_splitter.setObjectName("mainSplitter")
    self.main_splitter.setChildrenCollapsible(False)
    
    # 左侧：提示文字区域
    self.left_area = self._create_left_area()
    self.main_splitter.addWidget(self.left_area)
    
    # 右侧：选项+输入框区域
    self.right_area = self._create_right_area()
    self.main_splitter.addWidget(self.right_area)
    
    self._setup_horizontal_splitter_properties()
    splitter_layout.addWidget(self.main_splitter)
    
    return splitter_container

def _create_left_area(self) -> QWidget:
    """创建左侧区域（提示文字）"""
    left_widget = QWidget()
    left_layout = QVBoxLayout(left_widget)
    left_layout.setContentsMargins(15, 5, 15, 15)
    left_layout.setSpacing(10)
    
    # 添加提示文字区域
    self._create_description_area(left_layout)
    
    return left_widget

def _create_right_area(self) -> QWidget:
    """创建右侧区域（选项+输入框）"""
    right_widget = QWidget()
    right_layout = QVBoxLayout(right_widget)
    right_layout.setContentsMargins(15, 5, 15, 15)
    right_layout.setSpacing(10)
    
    # 添加选项区域（如果有）
    if self.predefined_options:
        self._create_options_checkboxes(right_layout)
    
    # 添加输入框区域
    self._create_input_submission_area(right_layout)
    
    return right_widget
```

##### 2.3.2 分割器属性设置
```python
def _setup_vertical_splitter_properties(self):
    """配置垂直分割器属性"""
    self.main_splitter.setHandleWidth(6)
    self.upper_area.setMinimumHeight(MIN_UPPER_AREA_HEIGHT)
    self.lower_area.setMinimumHeight(MIN_LOWER_AREA_HEIGHT)
    
    saved_sizes = self.settings_manager.get_splitter_sizes()
    self.main_splitter.setSizes(saved_sizes)
    
    self.main_splitter.splitterMoved.connect(self._on_vertical_splitter_moved)
    self._setup_splitter_double_click()

def _setup_horizontal_splitter_properties(self):
    """配置水平分割器属性"""
    self.main_splitter.setHandleWidth(6)
    self.left_area.setMinimumWidth(MIN_LEFT_AREA_WIDTH)
    self.right_area.setMinimumWidth(MIN_RIGHT_AREA_WIDTH)
    
    saved_sizes = self.settings_manager.get_horizontal_splitter_sizes()
    self.main_splitter.setSizes(saved_sizes)
    
    self.main_splitter.splitterMoved.connect(self._on_horizontal_splitter_moved)
    self._setup_splitter_double_click()

def _on_vertical_splitter_moved(self, pos: int, index: int):
    """垂直分割器移动时保存状态"""
    sizes = self.main_splitter.sizes()
    self.settings_manager.set_splitter_sizes(sizes)
    self.settings_manager.set_splitter_state(self.main_splitter.saveState())

def _on_horizontal_splitter_moved(self, pos: int, index: int):
    """水平分割器移动时保存状态"""
    sizes = self.main_splitter.sizes()
    self.settings_manager.set_horizontal_splitter_sizes(sizes)
    self.settings_manager.set_horizontal_splitter_state(self.main_splitter.saveState())
```

#### 2.4 设置界面扩展
**文件**: `src/feedback_ui/dialogs/settings_dialog.py`

##### 2.4.1 布局选项组件
```python
def _create_layout_group(self):
    """创建布局选择组"""
    self.layout_group = QGroupBox("")  # 标题稍后设置
    layout_group_layout = QVBoxLayout()
    
    # 获取当前布局设置
    current_layout = self.settings_manager.get_layout_direction()
    
    # 上下布局选项
    self.vertical_layout_radio = QRadioButton("")  # 文本稍后设置
    self.vertical_layout_radio.setChecked(current_layout == LAYOUT_VERTICAL)
    self.vertical_layout_radio.toggled.connect(
        lambda checked: self.switch_layout(LAYOUT_VERTICAL, checked)
    )
    layout_group_layout.addWidget(self.vertical_layout_radio)
    
    # 左右布局选项
    self.horizontal_layout_radio = QRadioButton("")  # 文本稍后设置
    self.horizontal_layout_radio.setChecked(current_layout == LAYOUT_HORIZONTAL)
    self.horizontal_layout_radio.toggled.connect(
        lambda checked: self.switch_layout(LAYOUT_HORIZONTAL, checked)
    )
    layout_group_layout.addWidget(self.horizontal_layout_radio)
    
    self.layout_group.setLayout(layout_group_layout)
    self.layout.addWidget(self.layout_group)

def switch_layout(self, layout_direction: str, checked: bool):
    """切换布局方向"""
    if checked:
        self.settings_manager.set_layout_direction(layout_direction)
        
        # 通知主窗口重新创建布局
        app_instance = QApplication.instance()
        if app_instance:
            for widget in app_instance.topLevelWidgets():
                if widget.__class__.__name__ == "FeedbackUI":
                    if hasattr(widget, "recreate_layout"):
                        widget.recreate_layout()
                    break
```

##### 2.4.2 多语言文本支持
```python
# 在 __init__ 方法中添加布局相关文本
self.texts.update({
    "layout_group": {"zh_CN": "页面布局", "en_US": "Page Layout"},
    "vertical_layout": {"zh_CN": "上下布局", "en_US": "Vertical Layout"},
    "horizontal_layout": {"zh_CN": "左右布局", "en_US": "Horizontal Layout"},
})
```

#### 2.5 样式适配
**文件**: `src/feedback_ui/styles/dark_theme.qss` 和 `src/feedback_ui/styles/light_theme.qss`

```css
/* 水平分割器样式 */
QSplitter[objectName="mainSplitter"]::handle:horizontal {
    width: 6px;
    min-width: 6px;
    max-width: 6px;
    background-color: #444444; /* 深色主题 */
    border: none;
    border-radius: 2px;
    margin: 2px 0px;
}

QSplitter[objectName="mainSplitter"]::handle:horizontal:hover {
    background-color: #555555;
}

QSplitter[objectName="mainSplitter"]::handle:horizontal:pressed {
    background-color: #333333;
}
```

### 📋 实施计划

#### 阶段1：底部区域优化（1-2小时）
1. 修改GitHub链接文字和样式
2. 调整各区域边距
3. 优化提交按钮高度
4. 测试界面效果

#### 阶段2：基础架构搭建（3-4小时）
1. 扩展常量定义
2. 扩展设置管理器
3. 重构主窗口布局创建方法
4. 实现基本的左右布局

#### 阶段3：功能完善（2-3小时）
1. 实现设置界面布局选项
2. 添加布局切换功能
3. 完善状态保存和恢复
4. 样式适配和优化

#### 阶段4：测试和优化（1-2小时）
1. 功能测试
2. 界面美化
3. 用户体验优化
4. 文档更新

### 🎯 验收标准

#### 底部区域优化
- [ ] GitHub链接文字改为"GitHub"
- [ ] 各区域边距减少，界面更紧凑
- [ ] 提交按钮高度适中
- [ ] 整体节省15-20px垂直空间

#### 左右布局功能
- [ ] 设置中可以切换上下/左右布局
- [ ] 左右布局正确显示：左侧提示文字，右侧选项+输入框
- [ ] 底部按钮区域横跨全宽
- [ ] 分割器可以左右拖拽调整
- [ ] 布局状态正确保存和恢复
- [ ] 主题切换时分割器样式正确更新
- [ ] 多语言支持正常

### 🔄 后续扩展

1. **响应式设计**：根据窗口大小自动调整布局
2. **更多布局选项**：如三栏布局等
3. **布局预设**：为不同使用场景提供预设布局
4. **快捷键切换**：支持键盘快捷键快速切换布局

---

**文档版本**: v1.0  
**创建日期**: 2024年12月  
**最后更新**: 2024年12月  
**负责人**: Augment Agent
