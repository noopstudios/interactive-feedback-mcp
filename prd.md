# 产品需求文档 (PRD): interactive-feedback-mcp 二次开发

## 1. 项目背景与目标

**项目名称:** interactive-feedback-mcp

**当前状态:** 一个本地部署的MCP服务器，通过 `interactive_feedback` 工具在 AI 辅助开发工具（如 Cursor）中实现人机交互反馈。核心技术栈为 Python, FastMCP, PySide6。

**二次开发目标:**
基于用户反馈和 `二次开发建议.md` 中的提议，对 `interactive-feedback-mcp` 项目进行功能增强和体验优化，旨在提升应用的易用性、美观度、功能丰富性，使其更加贴合实际开发场景，增强用户体验。

## 2. 核心需求

### 2.1. 用户界面 (UI) 现代化与优化

#### 2.1.1. UI 布局现代化
*   **需求描述:** 修改当前 UI 页面样式布局，使其更加合理易用。利用 Qt 布局管理器 (如 `QHBoxLayout`, `QVBoxLayout`, `QGridLayout`, `QFormLayout`) 重新组织 `feedback_ui.py` 中的界面元素。
*   **验收标准:**
    *   UI 元素（标签、输入框、按钮等）使用 Qt 布局管理器进行排列。
    *   窗口缩放时，内部元素能够自适应调整，避免重叠或显示不全。
    *   代码结构清晰，易于维护，避免手动设置控件坐标和尺寸。
*   **涉及文件:** `feedback_ui.py`

#### 2.1.2. 视觉样式美化 (Qt StyleSheets)
*   **需求描述:** 通过 Qt StyleSheets (QSS) 提升 UI 的视觉吸引力。可以考虑引入现成的暗色/亮色主题库（如 QDarkStyleSheet）或自定义 QSS。
*   **验收标准:**
    *   应用统一的视觉风格，包括颜色、边框、背景、字体等。
    *   按钮、输入框等控件具有现代化的外观和交互效果（如悬停效果）。
    *   样式定义清晰，易于修改和扩展。
*   **涉及文件:** `feedback_ui.py`, 可能需要在 `server.py` 或 `feedback_ui.py` 主程序入口应用全局样式。

### 2.2. 窗口行为调整

#### 2.2.1. 移除窗口"总在最前"行为
*   **需求描述:** 当前 UI 窗口一旦出现会置顶于所有页面，影响用户操作。需要移除 `Qt.WindowStaysOnTopHint` 标志。
*   **验收标准:**
    *   反馈窗口不再强制置顶。
    *   用户可以自由切换到其他应用程序窗口，反馈窗口表现与其他普通应用窗口一致。
*   **涉及文件:** `feedback_ui.py` (在主窗口类的构造函数中修改 `windowFlags`)

#### 2.2.2. 实现点击外部自动最小化
*   **需求描述:** 当用户点击 UI 页面外部的其他内容时，反馈 UI 页面能自动最小化。
*   **验收标准:**
    *   在反馈窗口可见且未最小化的情况下，当窗口失去激活状态 (例如用户点击其他应用窗口) 时，反馈窗口自动最小化。
    *   避免在反馈窗口的子对话框激活时错误地最小化主反馈窗口。
*   **涉及文件:** `feedback_ui.py` (通过重写 `event()` 方法并监视 `QEvent.WindowDeactivate`，或使用 `focusOutEvent()`)

### 2.3. UI 对话框功能增强

#### 2.3.1. 确保输入后只展示纯文本信息
*   **需求描述:** 当前输入内容可能携带文本样式。需确保从输入控件获取的是纯文本，并在后续处理和展示中保持纯文本格式。
*   **验收标准:**
    *   若使用 `QTextEdit` 作为输入控件，通过调用 `toPlainText()` 方法获取内容。
    *   若使用 `QLineEdit`，其 `text()` 方法返回的即为纯文本。
    *   最终提交或显示的反馈信息不包含任何富文本格式。
*   **涉及文件:** `feedback_ui.py` (在获取输入框内容的相关逻辑处)

#### 2.3.2. 新增粘贴图片功能
*   **需求描述:** 允许用户将剪贴板中的图片粘贴到反馈对话框中，并进行预览。
*   **验收标准:**
    *   提供一个"粘贴图片"按钮或通过快捷键 (Ctrl+V/Cmd+V) 触发。
    *   能够检测剪贴板中是否包含图片数据。
    *   成功粘贴图片后，在 UI 中显示图片的缩略图预览。
    *   如果剪贴板中无图片，应有适当提示或无操作。
*   **涉及文件:** `feedback_ui.py` (需要访问 `QApplication.clipboard()`, 处理 `QMimeData`, 使用 `QLabel` 进行预览)
*   **未来考虑:** 图片数据的处理方式（如 Base64 编码或保存路径）以便随反馈发送。

#### 2.3.3. 新增回车发送消息功能
*   **需求描述:** 在反馈输入框中，按回车键即可发送消息。允许通过 Shift+Enter 输入换行。
*   **验收标准:**
    *   对于 `QLineEdit`: 连接 `returnPressed` 信号到发送消息的槽函数。
    *   对于 `QTextEdit`: 重写 `keyPressEvent` 或使用事件过滤器，在非 Shift+Enter 的情况下，回车键触发消息发送；Shift+Enter 实现换行。
*   **涉及文件:** `feedback_ui.py`

### 2.4. 实现"常用语"功能

#### 2.4.1. 存储和管理用户自定义常用语
*   **需求描述:** 允许用户预设和管理常用的反馈短语。使用 `QSettings` 进行持久化存储。
*   **验收标准:**
    *   提供一个管理界面 (如 `QDialog`)，支持对常用语的增、删、改、查 (CRUD) 操作。
    *   常用语列表使用 `QListWidget` 显示。
    *   常用语数据通过 `QSettings` 保存和加载。
*   **涉及文件:** 新建一个管理常用语的 UI 类 (可在 `feedback_ui.py` 中或单独文件), `feedback_ui.py` (调用管理界面)

#### 2.4.2. 访问和使用常用语
*   **需求描述:** 在主反馈界面提供入口，方便用户快速选择并填充常用语到输入框。
*   **验收标准:**
    *   主反馈界面有一个"常用语"按钮或类似入口。
    *   点击后，弹出列表 (如 `QDialog`, `QMenu`, 或悬浮 `QListWidget`) 显示已保存的常用语。
    *   用户选择某条常用语后，该短语自动填充到主反馈输入框。
*   **涉及文件:** `feedback_ui.py`

## 3. 技术实现要点回顾

*   **UI 框架:** PySide6
*   **布局管理:** `QHBoxLayout`, `QVBoxLayout`, `QGridLayout`, `QFormLayout`
*   **样式:** Qt StyleSheets (QSS)
*   **窗口标志:** `Qt.WindowStaysOnTopHint` (移除), `setWindowFlags()`
*   **事件处理:** `event()`, `QEvent.WindowDeactivate`, `focusOutEvent()`, `keyPressEvent()`, `eventFilter()`
*   **剪贴板操作:** `QApplication.clipboard()`, `QMimeData`, `hasImage()`, `image()`
*   **信号与槽:** `returnPressed`
*   **数据持久化:** `QSettings`
*   **核心逻辑交互:** `server.py` 通过子进程调用 `feedback_ui.py`，并通过临时 JSON 文件传递数据。此机制在添加新功能（如发送图片数据）时可能需要调整或扩展。

## 4. 非功能性需求

*   **易用性:** 界面直观，操作便捷，符合用户习惯。
*   **稳定性:** 功能稳定，错误处理得当。
*   **可维护性:** 代码结构清晰，模块化，易于理解和修改。
*   **兼容性:** 尽量确保在目标用户的主要操作系统上表现一致 (基于 Qt 的跨平台特性)。

## 5. 后续开发路径建议 (优先级排序)

1.  **UI 布局与基础样式重构:** (2.1.1, 2.1.2) - 这是改善用户体验的基础。
2.  **窗口行为调整:** (2.2.1, 2.2.2) - 解决核心交互痛点。
3.  **UI 对话框功能增强 (文本与发送):** (2.3.1, 2.3.3) - 提升核心反馈流程效率。
4.  **常用语功能开发:** (2.4.1, 2.4.2) - 进一步提升效率。
5.  **UI 对话框功能增强 (图片粘贴):** (2.3.2) - 丰富表达方式，可作为后续迭代。

## 6. 未来考量 (超出本次开发范围)

*   **全面测试:** 在不同操作系统和场景下进行。
*   **代码模块化:** 如果 `feedback_ui.py` 过于复杂，考虑拆分自定义控件。
*   **高级错误处理:** 针对文件操作、网络（如果未来涉及）等。
*   **用户配置:** 为新增行为性功能提供用户配置选项。
*   **图片数据传输:** 如果图片粘贴功能需要将图片数据传回 `server.py`，需要设计相应的数据传输机制（如将图片内容 Base64 编码后加入返回的 JSON）。

---
**文档版本:** 1.0
**创建日期:** $(date +%Y-%m-%d) 